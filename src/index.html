<head>
  <title>Raw Protobuf Demo</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      width: 100%;
      margin: auto;
      padding: 2em;
    }
    p {
      margin-bottom: 2em;
    }
  </style>
</head>
<body>

<h1>Raw Protobuf Demo</h1>

<p>This will let you inspect a binary protobuf message (in a file.)</p>

<p>Checkout the <a href="https://github.com/konsumer/rawprotorust">source code.</a></p>

<p>
  Set the path (see <a href="https://github.com/confio/decode_raw">decode_raw</a> for more info):
  <input id="p" value='.' />
</p>

<p>
  Choose a file for your binary protobuf:
  <input type="file" id="f" />
</p>

<pre id="o2"></pre>

<script type="module">
import init, { parse_raw } from './rawproto.js'
await init()

const o2 = document.getElementById('o2')
const f = document.getElementById('f')
const p = document.getElementById('p')

let binary

const indent = (n=1, c = '  ') => [...(new Array(n))].map(() => c).join('')

function outputPrettyString (o, path) {
  let out = ''
  let i = ''
  for (const entry of o){
    i = indent(entry.path.length - path.split('.').length)
    if (entry.value === 'OpenNested'){
      out += `\n${i}{`
    } else if (entry.value === 'CloseNested'){
      out += `\n${i}}`
    } else {
      console.info(entry.value);
      const v = entry.value.Bytes !== undefined
        ? String.fromCharCode(...entry.value.Bytes)
        : entry.value.Varint !== undefined
          ? entry.value.Varint
          : entry.value.Fixed64 !== undefined
            ? entry.value.Fixed64
            : entry.value.Fixed32 !== undefined
              ? entry.value.Fixed32
              : undefined;
      const p = entry.path.join('.').replace(new RegExp(`^${path}`), '')
      out += `\n${i}${p}: ${v}`
    }
  }
  return out
}

function update(){
  o2.innerHTML = ''

  if (!binary){
    return
  }
  let path = p.value !== '' && p.value
  if (!path){
    return
  }
  
  const o = parse_raw(binary, path, { no_fixed64: false, no_fixed32: false })

  if (o){
    o2.innerHTML = outputPrettyString(o, path.replace(/^\.+/, ''))
  } else {
    o2.innerHTML = 'ERROR'
  }
}

f.addEventListener('change', () => {
  const reader = new FileReader()
  reader.onload = () => {
    binary = new Uint8Array(reader.result)
    update()
  }
  reader.readAsArrayBuffer(f.files[0])
})

p.addEventListener('keyup', () => {
  update()
})

</script>
</body>
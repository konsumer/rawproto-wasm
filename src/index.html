<head>
  <title>Raw Protobuf Demo</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      width: 100%;
      margin: auto;
      padding: 2em;
    }
    div {
      margin-bottom: 2em;
    }
  </style>
</head>
<body>

<div>
  Set the path (see <a href="https://github.com/confio/decode_raw">decode_raw</a> for more info):
  <input id="p" value='.' />
</div>

<div>
  Choose a file for your binary protobuf:
  <input type="file" id="f" />
</div>

<pre id="o2"></pre>

<script type="module">
import init, { parse_raw } from './rawproto.js'
await init()

const o2 = document.getElementById('o2')
const f = document.getElementById('f')
const p = document.getElementById('p')

let binary

function update(){
  if (!binary){
    alert('you need to choose a file.')
    return
  }
  const path = p.value !== '' && p.value
  if (!path){
    alert('you need to choose a path.')
    return
  }

  o2.innerHTML = ''
  
  const o = parse_raw(binary, path, { no_fixed64: true, no_fixed32: false })

  if (o){
    const displayVal = o
      .filter(i => i.value !== 'OpenNested' && i.value !== 'CloseNested')
      .reduce((o, v, i, a) => {
        const k = Object.values(v.value)
        return {...o, [v.path.join('.')]: k[0]}
      }, {})
    console.log(displayVal)
    o2.innerHTML = JSON.stringify(displayVal, null, 2)
  } else {
    o2.innerHTML = 'ERROR'
  }
}

f.addEventListener('change', () => {
  const reader = new FileReader()
  reader.onload = () => {
    binary = new Uint8Array(reader.result)
    update()
  }
  reader.readAsArrayBuffer(f.files[0])
})

p.addEventListener('keyup', () => {
  update()
})

</script>
</body>